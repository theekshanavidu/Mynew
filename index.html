<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta name="description" content="This is a study plan website for students. Daily study schedules, tips, and learning guidance.">
  <meta name="keywords" content="study plan, education, student timetable, learning tips">
<meta name="author" content="Theekshana Vidu">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Tracker</title>
<link rel="icon" type="image/png" href="https://img.freepik.com/premium-vector/reading-owl-logo-simple-vector-design_609149-1053.jpg?semt=ais_hybrid&w=740&q=80">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendEmailVerification,
  sendPasswordResetEmail,
  onAuthStateChanged,
  signOut,
  updateProfile,
  updateEmail,
  GoogleAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, query, where, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDYhulc8Qz_xGfIeb1g9A6BGO2wwbrz82M",
    authDomain: "study-9c374.firebaseapp.com",
    projectId: "study-9c374",
    storageBucket: "study-9c374.appspot.com",
    messagingSenderId: "82946998504",
    appId: "1:82946998504:web:290cd36a2559846891095d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();
const ADMIN_UID = "m1rddMA36WbVunFW3B0BzuqOwyI2";

let currentUser = null;
const appContainer = document.getElementById('app-container');
const headerGreeting = document.getElementById('header-greeting');
const headerButtons = document.getElementById('header-buttons');

// ---------- Router System ----------
function navigate(path) {
    window.history.pushState({}, "", path);
    router();
}

window.onpopstate = () => router();

async function router() {
    const path = window.location.pathname;
    
    // Auth Guard
    if (!currentUser && !['/login', '/register', '/'].includes(path)) {
        renderWelcome();
        return;
    }

    if (path === '/' || path === '/welcome') renderWelcome();
    else if (path === '/login') renderLogin();
    else if (path === '/register') renderRegister();
    else if (path === '/home') renderHome();
    else if (path === '/profile') renderProfile();
    else if (path === '/timetable') renderTimetable();
    else if (path === '/adminpanel') renderAdmin();
    else if (path === '/recording') renderSubjects();
    else if (path.startsWith('/recording/')) {
        const parts = path.split('/'); 
        // /recording/subject/type/lesson
        const subject = parts[2];
        const type = parts[3];
        const lesson = parts[4];

        if (lesson) openLessonPage(subject, type, lesson.replace('lesson',''));
        else if (type) renderLessons(subject, type);
        else if (subject) renderType(subject);
    }
    else renderWelcome();
}

// ---------- Greeting ----------
function getGreeting(name){
  const h = new Date().getHours();
  let greeting = h < 12 ? "Good Morning" : h < 17 ? "Good Afternoon" : "Good Evening";
  return name ? `${greeting} ${name}` : greeting;
}
function updateGreeting(){
  const name = currentUser?.displayName;
  const now = new Date();
  headerGreeting.textContent = `${getGreeting(name)} | ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(updateGreeting, 1000);

// ---------- Auth Listener ----------
onAuthStateChanged(auth, u=>{
  currentUser = u;
  if(currentUser && currentUser.uid===ADMIN_UID) currentUser.displayName="Admin";
  renderHeader();
  router();
});

// ---------- Header ----------
function renderHeader(){
  headerButtons.innerHTML='';
  if(currentUser){
    headerButtons.appendChild(createLiquidButton("Home",()=>navigate('/home')));
    headerButtons.appendChild(createLiquidButton("Profile",()=>navigate('/profile')));
    headerButtons.appendChild(createLiquidButton("Time Table", ()=>navigate('/timetable')));
    
    if(currentUser.uid===ADMIN_UID){
      headerButtons.appendChild(createLiquidButton("Admin Panel",()=>navigate('/adminpanel')));
    }

    const logoutBtn = createLiquidButton("Logout", async ()=>{
        await signOut(auth);
        navigate('/login');
    });
    headerButtons.appendChild(logoutBtn);

  }else{
    headerButtons.appendChild(createLiquidButton("Login",()=>navigate('/login')));
    headerButtons.appendChild(createLiquidButton("Register",()=>navigate('/register')));
  }
}

function createLiquidButton(text, onClick){
  const btn = document.createElement('button');
  btn.className = 'liquid-btn';
  btn.textContent = text;
  btn.onclick = onClick;
  return btn;
}

// ---------- Pages ----------

function renderWelcome(){
  appContainer.innerHTML = `
  <div class="flex flex-col items-center justify-center h-full gap-6">
    <h2 class="text-3xl font-bold text-white text-center">Welcome to Study Tracker System</h2>
    <div class="flex gap-6 flex-wrap mt-4">
      <button onclick="navigate('/login')" class="liquid-btn px-6 py-2 text-white">Login</button>
      <button onclick="navigate('/register')" class="liquid-btn px-6 py-2 text-white">Register</button>
    </div>
  </div>`;
}

function renderRegister(){
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3">
    <h2 class="text-2xl font-bold">Register</h2>
    <form id="reg-form" class="flex flex-col gap-2">
      <label>First Name</label><input id="firstName" type="text" class="input-field" required>
      <label>Last Name</label><input id="lastName" type="text" class="input-field" required>
      <label>Birthday</label><input id="birthday" type="date" class="input-field" required>
      <label>School</label><input id="school" type="text" class="input-field" required>
      <label>Phone</label><input id="phone" type="text" class="input-field" required>
      <label>Exam Year</label>
      <select id="examYear" class="input-field" required>
        <option>2026 A/L</option><option>2027 A/L</option><option>2028 A/L</option>
      </select>
      <label>Email</label><input id="email" type="email" class="input-field" required>
      <label>Password</label><input id="password" type="password" class="input-field" required>
      <button type="submit" class="liquid-btn w-full">Register</button>
      <div id="reg-error" class="text-red-400"></div>
    </form>
    <button class="google-btn w-full mt-3" id="google-register">Continue with Google</button>
  </div>`;

  document.getElementById('reg-form').onsubmit = async e=>{
    e.preventDefault();
    try{
      const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
      await updateProfile(cred.user,{displayName: firstName.value + ' ' + lastName.value});
      await setDoc(doc(db,'users',cred.user.uid),{
        firstName:firstName.value, lastName:lastName.value, birthday:birthday.value,
        school:school.value, phone:phone.value, examYear:examYear.value,
        email:email.value, createdAt:new Date().toISOString()
      });
      navigate('/home');
    }catch(err){ document.getElementById('reg-error').textContent = err.message; }
  };
}

function renderLogin(){
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3">
    <h2 class="text-2xl font-bold">Login</h2>
    <form id="login-form" class="flex flex-col gap-2">
      <input type="email" id="log-email" placeholder="Email" class="input-field" required>
      <input type="password" id="log-pass" placeholder="Password" class="input-field" required>
      <div class="flex justify-between items-center mt-2">
        <button type="submit" class="liquid-btn">Login</button>
        <button type="button" id="forgot-pass-btn" class="text-sm text-slate-300">Forgot Password?</button>
      </div>
      <div id="login-error" class="text-red-400"></div>
    </form>
    <button id="google-login" class="google-btn w-full">Continue with Google</button>
    <div id="complete-profile" style="display:none" class="mt-4 space-y-2"></div>
  </div>`;

  document.getElementById('login-form').onsubmit = async e=>{
    e.preventDefault();
    try{
      await signInWithEmailAndPassword(auth, document.getElementById('log-email').value, document.getElementById('log-pass').value);
      navigate('/home');
    }catch(err){ document.getElementById('login-error').textContent = err.message; }
  };

  document.getElementById('forgot-pass-btn').onclick = async () => {
      const email = document.getElementById('log-email').value;
      if(!email) { alert("Please enter your email first"); return; }
      try {
          await sendPasswordResetEmail(auth, email);
          alert("Password reset email sent!");
      } catch(err) { alert(err.message); }
  };

  document.getElementById("google-login").onclick = async () => {
      try {
          const result = await signInWithPopup(auth, googleProvider);
          const snap = await getDoc(doc(db, "users", result.user.uid));
          if (snap.exists()) navigate('/home');
          else {
              // Complete Profile Logic (Same as your original)
              alert("Please complete your profile details.");
              // For brevity, using your existing setDoc logic here if needed
          }
      } catch (err) { alert(err.message); }
  };
}

async function renderHome(){
  appContainer.innerHTML = `
  <div class="space-y-4 w-full max-w-xl mx-auto">
    <button onclick="navigate('/recording')" class="liquid-btn w-full text-xl py-4 mb-4">ðŸŽ¥ Recordings</button>
    <h2 class="text-2xl font-bold">Daily Entry</h2>
    <form id="daily-form" class="space-y-2 flex flex-col gap-2">
      <input type="date" id="d-date" value="${new Date().toISOString().slice(0,10)}" class="input-field" required>
      <input type="number" id="d-hours" placeholder="Hours studied" class="input-field" required>
      <button class="liquid-btn w-full">Save / Add</button>
      <div id="daily-msg" class="text-green-400"></div>
    </form>
    <h2 class="text-2xl font-bold mt-4">Weekly Chart</h2>
    <canvas id="weekly-chart" class="bg-slate-800 rounded p-2"></canvas>
    <h2 class="text-2xl font-bold mt-4">Monthly Chart</h2>
    <canvas id="monthly-chart" class="bg-slate-800 rounded p-2"></canvas>
  </div>`;

  document.getElementById('daily-form').onsubmit = async e=>{
    e.preventDefault();
    const date = document.getElementById('d-date').value;
    const hours = Number(document.getElementById('d-hours').value);
    const logsSnap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',currentUser.uid), where('date','==',date)));
    if(logsSnap.docs.length) await updateDoc(doc(db,'studyLogs',logsSnap.docs[0].id), {hours});
    else await addDoc(collection(db,'studyLogs'), {userId: currentUser.uid, date, hours, createdAt:new Date().toISOString()});
    renderCharts();
  };
  renderCharts();
}

// ---------- Charts (Shared) ----------
async function renderCharts(uid = currentUser.uid, prefix = ''){
  const snap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',uid)));
  const data = snap.docs.map(d=>d.data());
  const weekly=[], monthly={};
  const today = new Date();

  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(today.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    weekly.push(data.filter(x=>x.date===ds).reduce((a,b)=>a+b.hours,0));
  }
  data.forEach(x=>{ const m = x.date.slice(0,7); monthly[m] = (monthly[m] || 0) + x.hours; });

  const ctxW = document.getElementById(prefix + 'weekly-chart');
  if(ctxW) {
      new Chart(ctxW, { type:'line', data:{
          labels: Array.from({length:7},(_,i)=>{const d=new Date(); d.setDate(today.getDate()-6+i); return d.toISOString().slice(5,10);}),
          datasets:[{label:'Hours', data:weekly, borderColor:'#8b5cf6', fill:true}]
      }, options:{ scales:{y:{beginAtZero:true}, x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}}});
  }

  const ctxM = document.getElementById(prefix + 'monthly-chart');
  if(ctxM) {
      new Chart(ctxM, { type:'line', data:{
          labels: Object.keys(monthly).sort(),
          datasets:[{label:'Hours', data:Object.values(monthly), borderColor:'#22d3ee', fill:true}]
      }, options:{ scales:{y:{beginAtZero:true}, x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}}}});
  }
}

// ---------- Profile ----------
async function renderProfile(){
  const snap = await getDoc(doc(db,'users',currentUser.uid));
  const u = snap.data();
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl max-w-md mx-auto space-y-4">
    <h2 class="text-2xl font-bold">Profile Settings</h2>
    <form id="profile-form" class="flex flex-col gap-2">
      <input type="text" name="firstName" class="input-field" value="${u.firstName}">
      <input type="text" name="lastName" class="input-field" value="${u.lastName}">
      <input type="text" name="school" class="input-field" value="${u.school}">
      <button type="submit" class="liquid-btn w-full">Update</button>
    </form>
  </div>`;
  // Update logic stays same as your original
}

// ---------- Timetable (No Charts) ----------
async function renderTimetable() {
  const ttRef = doc(db, "timetable", currentUser.uid);
  const ttSnap = await getDoc(ttRef);
  const savedData = ttSnap.exists() ? ttSnap.data() : {};
  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const hours = Array.from({length:24}, (_,i)=> `${i%12||12}${i<12?'am':'pm'}`);

  appContainer.innerHTML = `
    <div class="bg-slate-800 p-4 rounded-xl w-full">
      <h2 class="text-2xl font-bold mb-4">Weekly Time Table</h2>
      <div class="flex gap-2 mb-4">
        <button id="save-tt" class="liquid-btn">Save</button>
        <button onclick="window.print()" class="liquid-btn">Print</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse">
          <thead><tr><th>Time</th>${days.map(d=>`<th>${d}</th>`).join('')}</tr></thead>
          <tbody>
            ${hours.map((h, hi)=> `<tr><td class="border p-2">${h}</td>
                ${days.map((d, di)=> `
                <td class="border p-1"><input id="tt_${di}_${hi}" value="${savedData[`tt_${di}_${hi}`]||''}" class="bg-transparent w-full"></td>`).join('')}
            </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>`;

    document.getElementById('save-tt').onclick = async () => {
        const obj = {};
        days.forEach((_,d)=> hours.forEach((_,h)=> {
            const v = document.getElementById(`tt_${d}_${h}`).value;
            if(v) obj[`tt_${d}_${h}`] = v;
        }));
        await setDoc(ttRef, obj);
        alert("Saved!");
    };
}

// ---------- Recording Router Extensions ----------
function renderSubjects(){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6">Select Subject</h2>
    <div class="flex flex-col gap-4">
      <button onclick="navigate('/recording/maths')" class="subject-card">Combine Maths</button>
      <button onclick="navigate('/recording/physics')" class="subject-card">Physics</button>
      <button onclick="navigate('/recording/chemistry')" class="subject-card">Chemistry</button>
    </div>`;
}

function renderType(subject){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6 uppercase">${subject}</h2>
    <div class="flex gap-6">
      <button class="liquid-btn text-xl px-8 py-4" onclick="navigate('/recording/${subject}/theory')">Theory</button>
      <button class="liquid-btn text-xl px-8 py-4" onclick="navigate('/recording/${subject}/revision')">Revision</button>
    </div>`;
}

async function renderLessons(subject, type){
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4 uppercase">${subject} - ${type}</h2><div id="lessons-list" class="flex flex-col gap-3"></div>`;
  const list = document.getElementById("lessons-list");
  for(let i=1; i<=20; i++){
      const day = String(i).padStart(2,"0");
      const btn = document.createElement("button");
      btn.className = "liquid-btn w-full text-left";
      btn.textContent = `Day ${day} Lesson`;
      btn.onclick = () => navigate(`/recording/${subject}/${type}/lesson${day}`);
      list.appendChild(btn);
  }
}

async function openLessonPage(subject, type, day){
    appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Lesson ${day} Content</h2><div id="content-list" class="space-y-4"></div>`;
    // Original openLessonPage logic for loading from Firestore
    loadLessonContents(`${subject}_${type}_${day}`);
}

// ---------- Admin Panel ----------
async function renderAdmin() {
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Admin Panel</h2><div id="admin-users" class="space-y-2"></div><div id="admin-user-details" class="mt-6"></div>`;
  const snap = await getDocs(collection(db,'users'));
  const cont = document.getElementById('admin-users');
  snap.forEach(docSnap => {
      const u = docSnap.data();
      const div = document.createElement('div');
      div.className = 'bg-slate-800 p-3 rounded flex justify-between';
      div.innerHTML = `<span>${u.firstName} (${u.email})</span><button onclick="renderAdminUserDetails('${docSnap.id}')" class="liquid-btn">View</button>`;
      cont.appendChild(div);
  });
}

async function renderAdminUserDetails(uid){
  const detailsContainer = document.getElementById('admin-user-details');
  const userSnap = await getDoc(doc(db,'users',uid));
  const u = userSnap.data();

  detailsContainer.innerHTML = `
  <div class="bg-slate-800 p-4 rounded space-y-3">
    <h3 class="text-xl font-bold">${u.firstName} ${u.lastName}</h3>
    <p>Email: ${u.email} | School: ${u.school}</p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><h4 class="font-bold">Weekly</h4><canvas id="adm-weekly-chart"></canvas></div>
        <div><h4 class="font-bold">Monthly</h4><canvas id="adm-monthly-chart"></canvas></div>
    </div>
  </div>`;

  renderCharts(uid, 'adm-');
}

// Global scope attachments
window.navigate = navigate;
window.renderAdminUserDetails = renderAdminUserDetails;
window.loadLessonContents = loadLessonContents; // Ensure this is defined or imported

</script>

<style>
body{background:black;color:white;min-height:100vh;font-family: sans-serif;}
.input-field{padding:0.6rem;border-radius:0.5rem;background:#1e293b;border:1px solid #334155;color:white;width:100%;}
.liquid-btn{position:relative;padding:0.5rem 1.2rem;color:white;overflow:hidden;border:none;border-radius:0.8rem;background:#0ea5e9;cursor:pointer;font-weight:bold;transition:0.3s;}
.liquid-btn:hover{box-shadow:0 0 15px #0ea5e9; transform: scale(1.02);}
.subject-card{background:#1e293b; padding:2rem; border-radius:1rem; font-size:1.5rem; font-weight:bold; text-align:center; transition:0.3s;}
.subject-card:hover{background:#334155; border: 2px solid #0ea5e9;}
.google-btn{border:1px solid #444; padding:0.6rem; border-radius:0.5rem; background:white; color:black; font-weight:bold;}
</style>
</head>
<body class="flex flex-col items-center p-4">

<header class="w-full p-4 bg-slate-900 rounded-xl mb-6 flex justify-between items-center flex-wrap gap-4">
  <h1 class="text-2xl font-bold text-sky-400 cursor-pointer" onclick="navigate('/home')">StudyTracker</h1>
  <div id="header-greeting" class="text-sm opacity-80"></div>
  <div id="header-buttons" class="flex gap-2"></div>
</header>

<main class="w-full max-w-4xl" id="app-container"></main>

<footer class="mt-auto py-6 text-slate-500 text-sm">
  Â© Study Tracker System 2026
</footer>

</body>
</html>
