<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta name="description" content="This is a study plan website for students. Daily study schedules, tips, and learning guidance.">
  <meta name="keywords" content="study plan, education, student timetable, learning tips">
<meta name="author" content="Theekshana Vidu">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Tracker</title>
<link rel="icon" type="image/png" href="https://img.freepik.com/premium-vector/reading-owl-logo-simple-vector-design_609149-1053.jpg?semt=ais_hybrid&w=740&q=80">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendEmailVerification,
  sendPasswordResetEmail,
  onAuthStateChanged,
  signOut,
  updateProfile,
  updateEmail,
  GoogleAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, collection, getDocs, getDoc, query, where, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";



const firebaseConfig = {
    apiKey: "AIzaSyDYhulc8Qz_xGfIeb1g9A6BGO2wwbrz82M",
    authDomain: "study-9c374.firebaseapp.com",
    projectId: "study-9c374",
    storageBucket: "study-9c374.appspot.com",
    messagingSenderId: "82946998504",
    appId: "1:82946998504:web:290cd36a2559846891095d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();
const ADMIN_UID = "m1rddMA36WbVunFW3B0BzuqOwyI2";

let currentUser = null;
const appContainer = document.getElementById('app-container');
const headerGreeting = document.getElementById('header-greeting');
const headerButtons = document.getElementById('header-buttons');

// ---------- ROUTER SYSTEM ----------
function navigateTo(path) {
  window.location.hash = path;
}

window.addEventListener('hashchange', router);

async function router() {
  const path = window.location.hash.slice(1) || '/';
  renderHeader();

  if (path === '/' || path === '/welcome') { renderWelcome(); return; }
  if (path === '/login') { renderLogin(); return; }
  if (path === '/register') { renderRegister(); return; }

  if (!currentUser) {
    renderWelcome();
    return;
  }

  if (path === '/home') { renderHome(); }
  else if (path === '/profile') { renderProfile(); }
  else if (path === '/timetable') { renderTimetable(); }
  else if (path === '/adminpanel') { renderAdmin(); }
  else if (path === '/recording') { renderSubjects(); }
  
  else if (path.startsWith('/recording/')) {
    const parts = path.split('/'); 
    const subject = parts[2];
    const type = parts[3];
    const lesson = parts[4];

    if (subject && type && lesson) {
      const day = lesson.replace('lesson', '');
      openLessonPage(subject, type, day);
    } else if (subject && type) {
      renderLessons(subject, type);
    } else if (subject) {
      renderType(subject);
    }
  }
}

// ---------- Greeting ----------
function getGreeting(name){
  const h = new Date().getHours();
  let greeting = h < 12 ? "Good Morning" : h < 17 ? "Good Afternoon" : "Good Evening";
  return name ? `${greeting} ${name}` : greeting;
}
function updateGreeting(){
  const name = currentUser?.displayName;
  const now = new Date();
  headerGreeting.textContent = `${getGreeting(name)} | ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
}
setInterval(updateGreeting, 1000);

// ---------- Auth Listener ----------
onAuthStateChanged(auth, u=>{
  currentUser = u;
  if(currentUser && currentUser.uid===ADMIN_UID) currentUser.displayName="Admin";
  
  if(!window.location.hash || window.location.hash === '#/') {
    navigateTo(currentUser ? '/home' : '/welcome');
  } else {
    router();
  }
});


// ---------- Header ----------
function renderHeader(){
  headerButtons.innerHTML='';
  if(currentUser){
    const homeBtn = createLiquidButton("Home",()=>navigateTo('/home'));
    const profileBtn = createLiquidButton("Profile",()=>navigateTo('/profile'));
    const timetableBtn = createLiquidButton("Time Table", ()=>navigateTo('/timetable'));
    headerButtons.appendChild(timetableBtn);
    headerButtons.appendChild(homeBtn);
    headerButtons.appendChild(profileBtn);

    if(currentUser.uid===ADMIN_UID){
      const adminBtn = createLiquidButton("Admin Panel",()=>navigateTo('/adminpanel'));
      headerButtons.appendChild(adminBtn);
    }

    const logoutBtn = createLiquidButton("Logout", async ()=>{
        await signOut(auth);
        navigateTo('/welcome');
    });
    headerButtons.appendChild(logoutBtn);

  }else{
    const loginBtn = createLiquidButton("Login",()=>navigateTo('/login'));
    const regBtn = createLiquidButton("Register",()=>navigateTo('/register'));
    headerButtons.appendChild(loginBtn);
    headerButtons.appendChild(regBtn);
  }
}

function createLiquidButton(text, onClick){
  const btn = document.createElement('button');
  btn.className = 'liquid-btn';
  btn.textContent = text;
  btn.onclick = onClick;
  return btn;
}

// ---------- Welcome ----------
function renderWelcome(){
  appContainer.innerHTML = `
  <div class="flex flex-col items-center justify-center h-full gap-6">
    <h2 class="text-3xl font-bold text-white text-center">Welcome to Study Tracker System</h2>
    <div class="flex gap-6 flex-wrap mt-4">
      <button id="welcome-login-btn" class="liquid-btn px-6 py-2 text-white">Login</button>
      <button id="welcome-register-btn" class="liquid-btn px-6 py-2 text-white">Register</button>
    </div>
  </div>`;
  document.getElementById('welcome-login-btn').onclick = () => navigateTo('/login');
  document.getElementById('welcome-register-btn').onclick = () => navigateTo('/register');
}

// ---------- Register ----------
function renderRegister(){
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3">
    <h2 class="text-2xl font-bold">Register</h2>
    <form id="reg-form" class="flex flex-col gap-2">
      <label>First Name</label>
      <input id="firstName" type="text" placeholder="First Name" class="input-field" required>
      <label>Last Name</label>
      <input id="lastName" type="text" placeholder="Last Name" class="input-field" required>
      <label>Birthday</label>
      <input id="birthday" type="date" class="input-field" required>
      <label>School</label>
      <input id="school" type="text" placeholder="School" class="input-field" required>
      <label>Phone</label>
      <input id="phone" type="text" placeholder="Phone" class="input-field" required>
      <label>Exam Year</label>
      <select id="examYear" class="input-field" required>
        <option>2026 A/L</option>
        <option>2027 A/L</option>
        <option>2028 A/L</option>
      </select>
      <label>Email</label>
      <input id="email" type="email" placeholder="Email" class="input-field" required>
      <label>Password</label>
      <input id="password" type="password" placeholder="Password" class="input-field" required>
      <button type="submit" class="liquid-btn w-full">Register</button>
      <div id="reg-error" class="text-red-400"></div>
    </form>
    <button class="google-btn w-full mt-3" id="google-register">
     <img src="https://img.freepik.com/premium-vector/google-logo-icon-transparent-background_1273375-1570.jpg?semt=ais_hybrid&w=740&q=80" class="google-logo" alt="Google logo"> Continue with Google
    </button>
  </div>`;

  document.getElementById('reg-form').onsubmit = async e=>{
    e.preventDefault();
    try{
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      await updateProfile(cred.user, {displayName: firstName + ' ' + lastName});
      await setDoc(doc(db,'users',cred.user.uid),{
        firstName, lastName,
        birthday: document.getElementById('birthday').value,
        school: document.getElementById('school').value,
        phone: document.getElementById('phone').value,
        examYear: document.getElementById('examYear').value,
        email, createdAt: new Date().toISOString()
      });
      navigateTo('/home');
    }catch(err){ document.getElementById('reg-error').textContent = err.message; }
  };
}

// ---------- Login ----------
function renderLogin(){
  appContainer.innerHTML = `
  <div id="auth-section" class="bg-slate-800 p-6 rounded-xl w-full max-w-md mx-auto space-y-3">
    <h2 class="text-2xl font-bold">Login</h2>
    <form id="login-form" class="flex flex-col gap-2">
      <input type="email" name="email" placeholder="Email" class="input-field" required>
      <input type="password" name="password" placeholder="Password" class="input-field" required>
      <div class="flex justify-between items-center mt-2">
        <button type="submit" class="liquid-btn">Login</button>
      </div>
      <div id="login-error" class="text-red-400"></div>
    </form>
    <button id="google-login" class="google-btn w-full">
      <img src="https://img.freepik.com/premium-vector/google-logo-icon-transparent-background_1273375-1570.jpg?semt=ais_hybrid&w=740&q=80" alt="Google" class="google-logo"> Continue with Google
    </button>
    <div id="complete-profile" style="display:none" class="mt-4 space-y-2"></div>
  </div>`;

  document.getElementById('login-form').onsubmit = async e=>{
    e.preventDefault();
    try{
      await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
      navigateTo('/home');
    }catch(err){ document.getElementById('login-error').textContent = err.message; }
  };

  document.getElementById("google-login").onclick = async () => {
    try {
      const result = await signInWithPopup(auth, googleProvider);
      const user = result.user;
      const snap = await getDoc(doc(db, "users", user.uid));
      if (snap.exists()) { navigateTo('/home'); } 
      else {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("google-login").style.display = "none";
        const cp = document.getElementById("complete-profile");
        cp.style.display = "block";
        cp.innerHTML = `
          <h2 class="text-xl font-bold">Complete Profile</h2>
          <input id="cp-fname" placeholder="First Name" class="input-field">
          <input id="cp-lname" placeholder="Last Name" class="input-field">
          <input id="cp-school" placeholder="School" class="input-field">
          <select id="cp-year" class="input-field"><option>2026 A/L</option><option>2027 A/L</option><option>2028 A/L</option></select>
          <button id="cp-save" class="liquid-btn w-full">Save</button>`;
        document.getElementById("cp-save").onclick = async () => {
          const data = {
            firstName: document.getElementById("cp-fname").value,
            lastName: document.getElementById("cp-lname").value,
            school: document.getElementById("cp-school").value,
            examYear: document.getElementById("cp-year").value,
            email: user.email, createdAt: new Date().toISOString()
          };
          await setDoc(doc(db, "users", user.uid), data);
          await updateProfile(user, { displayName: data.firstName + ' ' + data.lastName });
          navigateTo('/home');
        };
      }
    } catch (err) { alert(err.message); }
  };
}

// ---------- Home ----------
async function renderHome(){
  appContainer.innerHTML = `
  <div class="space-y-4 w-full max-w-xl mx-auto">
    <button id="recording-btn" class="liquid-btn w-full text-xl py-4 mb-4">ðŸŽ¥ Recordings</button>
    <h2 class="text-2xl font-bold">Daily Entry</h2>
    <form id="daily-form" class="space-y-2 flex flex-col gap-2">
      <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" class="input-field" required>
      <input type="number" name="hours" placeholder="Hours studied" class="input-field" required>
      <button class="liquid-btn w-full">Save / Add</button>
      <div id="daily-msg" class="text-green-400"></div>
    </form>
    <h2 class="text-2xl font-bold mt-4">Weekly Chart</h2>
    <canvas id="weekly-chart" class="bg-slate-800 rounded p-2"></canvas>
    <h2 class="text-2xl font-bold mt-4">Monthly Chart</h2>
    <canvas id="monthly-chart" class="bg-slate-800 rounded p-2"></canvas>
  </div>`;
  
  document.getElementById('daily-form').onsubmit = async e=>{
    e.preventDefault();
    const f = e.target;
    const logsSnap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',currentUser.uid), where('date','==',f.date.value)));
    if(logsSnap.docs.length){
      await updateDoc(doc(db,'studyLogs',logsSnap.docs[0].id), {hours: Number(f.hours.value)});
    } else {
      await addDoc(collection(db,'studyLogs'), {userId: currentUser.uid, date: f.date.value, hours: Number(f.hours.value)});
    }
    renderCharts();
  };
  document.getElementById("recording-btn").onclick = () => navigateTo('/recording');
  renderCharts();
}

// ---------- Charts ----------
async function renderCharts(userId = currentUser.uid, canvasIds = {weekly: 'weekly-chart', monthly: 'monthly-chart'}){
  const snap = await getDocs(query(collection(db,'studyLogs'), where('userId','==',userId)));
  const data = snap.docs.map(d=>d.data());
  const today = new Date();
  
  // Weekly
  const weeklyLabels = [];
  const weeklyData = [];
  for(let i=6;i>=0;i--){
    const d = new Date(); d.setDate(today.getDate()-i);
    const ds = d.toISOString().slice(0,10);
    weeklyLabels.push(ds.slice(5,10));
    weeklyData.push(data.filter(x=>x.date===ds).reduce((a,b)=>a+b.hours,0));
  }

  // Monthly
  const monthlyObj = {};
  data.forEach(x=>{ const m = x.date.slice(0,7); monthlyObj[m] = (monthlyObj[m]||0) + x.hours; });
  const months = Object.keys(monthlyObj).sort();

  const ctxW = document.getElementById(canvasIds.weekly);
  if(ctxW){
    if(window[`chartW_${canvasIds.weekly}`]) window[`chartW_${canvasIds.weekly}`].destroy();
    window[`chartW_${canvasIds.weekly}`] = new Chart(ctxW, {
      type:'line', data:{ labels:weeklyLabels, datasets:[{label:'Hours', data:weeklyData, borderColor:'#8b5cf6', fill:true}] },
      options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { labels: { color: '#fff' } } } }
    });
  }

  const ctxM = document.getElementById(canvasIds.monthly);
  if(ctxM){
    if(window[`chartM_${canvasIds.monthly}`]) window[`chartM_${canvasIds.monthly}`].destroy();
    window[`chartM_${canvasIds.monthly}`] = new Chart(ctxM, {
      type:'line', data:{ labels:months, datasets:[{label:'Monthly Hours', data:months.map(m=>monthlyObj[m]), borderColor:'#22d3ee', fill:true}] },
      options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { labels: { color: '#fff' } } } }
    });
  }
}

// ---------- Profile ----------
async function renderProfile(){
  const snap = await getDoc(doc(db,'users',currentUser.uid));
  const u = snap.data();
  appContainer.innerHTML = `
  <div class="bg-slate-800 p-6 rounded-xl max-w-md mx-auto space-y-4">
    <h2 class="text-2xl font-bold">Update Profile</h2>
    <form id="profile-form" class="flex flex-col gap-2">
      <input type="text" name="firstName" class="input-field" value="${u.firstName}" required>
      <input type="text" name="lastName" class="input-field" value="${u.lastName}" required>
      <input type="text" name="school" class="input-field" value="${u.school}" required>
      <button type="submit" class="liquid-btn w-full">Update</button>
    </form>
  </div>`;
  document.getElementById('profile-form').onsubmit = async e=>{
    e.preventDefault();
    await updateDoc(doc(db,'users',currentUser.uid), {firstName: e.target.firstName.value, lastName: e.target.lastName.value, school: e.target.school.value});
    alert("Updated!");
  };
}

// ---------- Time Table (Charts removed from bottom) ----------
async function renderTimetable() {
  const ttRef = doc(db, "timetable", currentUser.uid);
  const ttSnap = await getDoc(ttRef);
  const savedData = ttSnap.exists() ? ttSnap.data() : {};
  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
  const hours = Array.from({length:24}, (_,i)=> `${i%12||12}${i<12?'am':'pm'}`);

  appContainer.innerHTML = `
    <div class="bg-slate-800 p-4 rounded-xl w-full flex flex-col gap-4">
      <h2 class="text-2xl font-bold">Weekly Time Table</h2>
      <div class="flex gap-2 mb-2"><button id="save-tt" class="liquid-btn">Save</button></div>
      <div class="overflow-x-auto w-full">
        <table class="border border-slate-600 text-sm table-auto min-w-max">
          <thead><tr><th class="border p-2">Hour</th>${days.map(d=>`<th class="border p-2">${d}</th>`).join("")}</tr></thead>
          <tbody>
            ${hours.map((h, hi)=> `<tr><td class="border p-2">${h}</td>${days.map((d, di)=> `
              <td class="border p-1"><input id="tt_${di}_${hi}" class="bg-slate-900 p-1 rounded text-center w-24" value="${savedData[`tt_${di}_${hi}`]||''}"></td>
            `).join("")}</tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>`;

  document.getElementById("save-tt").onclick = async ()=>{
    const data = {};
    days.forEach((_,d)=> hours.forEach((_,h)=>{
      const val = document.getElementById(`tt_${d}_${h}`).value;
      if(val) data[`tt_${d}_${h}`] = val;
    }));
    await setDoc(ttRef, data);
    alert("Saved!");
  };
}

// ---------- Recording Routes ----------
function renderSubjects(){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6">Select Subject</h2>
    <div class="flex flex-col gap-4">
      <button onclick="navigateTo('/recording/combine')" class="bg-slate-800 p-4 rounded-xl text-left">Combine Maths</button>
      <button onclick="navigateTo('/recording/physics')" class="bg-slate-800 p-4 rounded-xl text-left">Physics</button>
      <button onclick="navigateTo('/recording/chemistry')" class="bg-slate-800 p-4 rounded-xl text-left">Chemistry</button>
    </div>`;
}

function renderType(subject){
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-6 uppercase">${subject}</h2>
    <div class="flex gap-4">
      <button class="liquid-btn" onclick="navigateTo('/recording/${subject}/theory')">Theory</button>
      <button class="liquid-btn" onclick="navigateTo('/recording/${subject}/revision')">Revision</button>
    </div>`;
}

async function renderLessons(subject, type){
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4 uppercase">${subject} - ${type}</h2><div id="lessons-list" class="space-y-2"></div>`;
  const list = document.getElementById("lessons-list");
  for(let i=1; i<=20; i++){
    const day = String(i).padStart(2,"0");
    const btn = document.createElement("button");
    btn.className = "liquid-btn w-full text-left";
    btn.textContent = `Lesson ${day}`;
    btn.onclick = () => navigateTo(`/recording/${subject}/${type}/lesson${day}`);
    list.appendChild(btn);
  }
}

async function openLessonPage(subject, type, day){
  appContainer.innerHTML = `<h2 class="text-2xl font-bold mb-4">Lesson ${day}</h2><div id="content-list">Loading...</div>`;
}

// ---------- Admin Panel (Fixes applied here) ----------
async function renderAdmin() {
  appContainer.innerHTML = `
    <h2 class="text-2xl font-bold mb-4">Admin Panel</h2>
    <input id="admin-search" placeholder="Search Users..." class="input-field mb-4">
    <div id="admin-users" class="space-y-2"></div>
    <div id="admin-user-details" class="mt-8 border-t border-slate-700 pt-4"></div>`;
    
  const usersSnap = await getDocs(collection(db,'users'));
  const users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
  
  const display = (list) => {
    const cont = document.getElementById('admin-users');
    cont.innerHTML = '';
    list.forEach(u => {
      const div = document.createElement('div');
      div.className = 'bg-slate-800 p-3 rounded flex justify-between items-center';
      div.innerHTML = `<span>${u.firstName} ${u.lastName}</span> <button onclick="window.renderAdminUserDetails('${u.id}')" class="liquid-btn">View Data</button>`;
      cont.appendChild(div);
    });
  };
  display(users);
  document.getElementById('admin-search').oninput = e => display(users.filter(u => (u.firstName+' '+u.lastName).toLowerCase().includes(e.target.value.toLowerCase())));
}

async function renderAdminUserDetails(uid){
  const details = document.getElementById('admin-user-details');
  details.innerHTML = "Loading User Data...";
  
  const userSnap = await getDoc(doc(db,'users',uid));
  if(!userSnap.exists()) return;
  const u = userSnap.data();
  
  details.innerHTML = `
    <div class="bg-slate-900 p-6 rounded-xl space-y-4">
      <h3 class="text-2xl font-bold text-blue-400">${u.firstName} ${u.lastName}</h3>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <p>Email: ${u.email}</p>
        <p>School: ${u.school}</p>
        <p>Exam: ${u.examYear}</p>
        <p>Phone: ${u.phone || 'N/A'}</p>
      </div>
      <div class="mt-6">
        <h4 class="font-bold mb-2">Study Progress</h4>
        <canvas id="admin-chart-w" class="mb-4 bg-slate-800 p-2 rounded"></canvas>
        <canvas id="admin-chart-m" class="bg-slate-800 p-2 rounded"></canvas>
      </div>
    </div>`;
    
  // Important: Wait for DOM to update before drawing charts
  setTimeout(() => {
    renderCharts(uid, {weekly: 'admin-chart-w', monthly: 'admin-chart-m'});
  }, 100);
}

// Global scope assignments
window.renderAdminUserDetails = renderAdminUserDetails;
window.navigateTo = navigateTo;

</script>

<style>
body{background:black;color:white;font-family:sans-serif;}
.input-field{padding:0.7rem; border-radius:0.5rem; background:#1e293b; border:none; color:white; width:100%;}
.liquid-btn{padding:0.5rem 1.2rem; background:#0ea5e9; border-radius:0.8rem; font-weight:bold; cursor:pointer; transition:0.3s; display:inline-block;}
.liquid-btn:hover{box-shadow:0 0 15px #0ea5e9;}
.google-btn{display:flex; align-items:center; justify-content:center; gap:10px; padding:0.6rem; border:1px solid #0ea5e9; border-radius:0.5rem; background:transparent; color:white; cursor:pointer;}
.google-logo{width:20px;}
</style>
</head>
<body class="p-4">
<header class="flex justify-between items-center bg-slate-900 p-4 rounded-xl mb-6">
  <h1 class="text-xl font-bold cursor-pointer" onclick="navigateTo('/home')">StudyTracker</h1>
  <div id="header-greeting" class="text-xs hidden sm:block"></div>
  <div id="header-buttons" class="flex gap-2"></div>
</header>
<main id="app-container" class="max-w-4xl mx-auto"></main>
</body>
</html>
